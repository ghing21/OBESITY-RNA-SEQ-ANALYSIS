---
title: "DEXSeq_GSE165932"
format: html
editor: visual
---

## Load environment and data

```{r}
library(DEXSeq)
library(fgsea)
library(msigdbr)
library(tidyverse)
library(readxl)
library(fgsea)
library(ggrepel)
library(dplyr)
load(file='/home/projects/22140/exam_data/exam_functions.Rdata')
```

## Set seed for reproducibility

```{r}
set.seed(123)
```

## Load count matrices at gene and isoform resolution and genes-isoforms mapping

```{r}
# Load isoforms count matrix
iso_count_matrix_1 <- loadIsoformCountMatrix("GSE165932")

# Load genes count matrix
gene_count_matrix_1 <- extractGeneCountMatrixFromIsoCounts(iso_count_matrix_1)

# Load genes-isoforms mapping
isoInfo <- read_rds(
paste0(
'/home/projects/22140/exam_data/',
'Homo_sapiens.GRCh38.107.chr_patch_hapl_scaff_tx_info.Rds'
)
)
```

## Load metadata

```{r}
gene_meta_1 <- read_excel("../data/GSE165932/metadata_GSE165932.xlsx")
```

Remove the samples for which we don't have metadata

```{r}
samples <- gene_meta_1$sample

gene_count_matrix_1 <- gene_count_matrix_1[, samples]
iso_count_matrix_1  <- iso_count_matrix_1[, samples]

dim(iso_count_matrix_1)   
dim(gene_count_matrix_1)  
```

Filter the isoform matrix to remove all the lowly expressed isoforms.

```{r}
# Remove isoforms with total count = 0 across all samples
iso_keep <- rowSums(iso_count_matrix_1) > 0
iso_count_matrix_1 <- iso_count_matrix_1[iso_keep, ]

# Remove isoforms expressed in very few samples
iso_keep2 <- rowSums(iso_count_matrix_1 >= 10) >= 3
iso_count_matrix_1 <- iso_count_matrix_1[iso_keep2, ]

filtered_isoforms <- nrow(iso_count_matrix_1)
filtered_isoforms
```

```{r}
# Filter isoInfo to match the filtered matrix
isoInfo_subset_1 <- isoInfo |>
  filter(transcript_id %in% rownames(iso_count_matrix_1))

# Reorder
isoInfo_subset_1 <- isoInfo_subset_1[
  match(rownames(iso_count_matrix_1), isoInfo_subset_1$transcript_id),
]

nrow(iso_count_matrix_1)
nrow(isoInfo_subset_1)
all(rownames(iso_count_matrix_1) == isoInfo_subset_1$transcript_id)
```

Check that the order of the samples in the count matrix and isoform matrix is the same as well as in the metadata

```{r}
#check that the order in the count matrix and isoform matrix is the same
all(colnames(gene_count_matrix_1) == colnames(iso_count_matrix_1))

# Check that the order in metadata is the same
all(gene_meta_1$sample == colnames(gene_count_matrix_1))
all(gene_meta_1$sample == colnames(iso_count_matrix_1))

# Check that the num of columns is identical
ncol(gene_count_matrix_1)
ncol(iso_count_matrix_1)
```

### Differential Isoform Expression

```{r}
# Create the DEXSeqDataSet 
dxd_1 <- DEXSeqDataSet(
  countData = iso_count_matrix_1,
  sampleData = gene_meta_1,
  design = ~ sample + exon + condition:exon + insulin:exon,
  featureID = isoInfo_subset_1$transcript_id,
  groupID   = isoInfo_subset_1$gene_id
)
dxd_1
```

```{r}
# Run DEXSeq (obesity effect, insulin as cofactor)
dxd_results_1 <- DEXSeq(
  dxd_1,
  fullModel    = ~ sample + exon + condition:exon + insulin:exon,
  reducedModel = ~ sample + exon + insulin:exon,
  BPPARAM      = BiocParallel::MulticoreParam(4)  
)
```

```{r}
saveRDS(dxd_results_1, file = "../results/dexseq_results_GSE165932.rds")
```

```{r}
# How many isoforms were actually tested
sum(!is.na(dxd_results_1$stat))
```

```{r}
saveRDS(dxd_results_1, file = "../results/dexseq_results_GSE165932.rds")
```

### Collapse isoform-level results into gene-level results

```{r}
dexseqResultGene_1 <- 
  # Turn the DEXSeqResults object into a plain tibble
  dxd_results_1  |> 
  as.data.frame()  |> 
  as_tibble()  |> 
  # Remove rows with NULL values in stat column
  filter(!is.na(stat))  |> 
  # Select and rename columns
  dplyr::select(
    gene_id    = groupID,
    isoform_id = featureID,
    stat,
    log2FC = log2fold_Obese_Normal,
    pvalue,
    padj
  )  |> 
  # Group by gene to include all the corresponding isoforms
  group_by(gene_id)  |> 
  # For each gene, keep only the single isoform with the smallest p-value
  slice_min(order_by = pvalue, n = 1, with_ties = FALSE) |> 
  ungroup() |> 
  # Recalculate FDR across genes using those per-gene minimal p-values.
  mutate(
    padj_gene = p.adjust(pvalue, method = "fdr")
  )
```

```{r}
# umber of genes showing differential isoform usage
sum(dexseqResultGene_1$padj_gene < 0.05, na.rm = TRUE)
```

### COMPARE DEXSeq vs DESeq2 results

```{r}
# Load DESeq2 results
de_results_1 <- readRDS("../results/GSE165932_results.rds")
```

```{r}
# Clean ENSEMBL IDs if they contain version suffixes
de_results_1 <- de_results_1  |> 
  mutate(gene_id_clean = sub("\\.\\d+$", "", gene_id))

dexseqResultGene_1 <- dexseqResultGene_1 |> 
  mutate(gene_id_clean = sub("\\.\\d+$", "", gene_id))
```

```{r}
#Add significance flags - Define significant genes
alpha <- 0.05

de_results_1 <- de_results_1  |> 
  mutate(DE_sig = padj < alpha)

dexseqResultGene_1 <- dexseqResultGene_1  |> 
  mutate(DEX_sig = padj_gene < alpha)

```

```{r}
# Find genes that are present in both analysis
shared_genes <- intersect(de_results_1$gene_id_clean, dexseqResultGene_1$gene_id_clean)

# Merge DE + DEX results
# Create one table that contains both results for the same genes
merged <- inner_join(
  de_results_1   |>  
    filter(gene_id_clean %in% shared_genes),
  dexseqResultGene_1 |> 
    filter(gene_id_clean %in% shared_genes),
  by = "gene_id_clean"
)

# Contingency table (DEXSeq vs DESeq2 significance)
cont_tab_1   <- table(
  DEX = merged$DEX_sig,
  DE  = merged$DE_sig
)
cont_tab_1
```

```{r}
# Fisher exact test
fisher_res_1 <- fisher.test(cont_tab_1, alternative = "greater")
fisher_res_1
```

**p =** 0.0001376 → highly significant

Odds ratio = 9 genes with dex are 9 times more likely to be DE than by chance

The overlap between DE and DIU is statistically significant. Although the overlap is small (only 6 genes), those 6 genes occur much more often than would be expected by random chance (OR ≈ 9).

364 genes (\~98%) were significant only for DEX but not DE, showing that isoform-level regulation reveals substantial biological information that gene-level expression analysis misses.

### Compare to Differential Expression at Gene-set Level

```{r}
# Biological Process
GO_BP <- msigdbr(
  species = "Homo sapiens", 
  category = "C5", 
  subcategory = "BP")  |> 
  dplyr::select(gs_name, ensembl_gene)

# Cellular Component
GO_CC <- msigdbr(
  species = "Homo sapiens", 
  category = "C5", 
  subcategory = "CC")  |> 
  dplyr::select(gs_name, ensembl_gene)

# Molecular Function
GO_MF <- msigdbr(
  species = "Homo sapiens", 
  category = "C5", 
  subcategory = "MF")  |> 
  dplyr::select(gs_name, ensembl_gene)

BP_list <- split(GO_BP$ensembl_gene, GO_BP$gs_name)
CC_list <- split(GO_CC$ensembl_gene, GO_CC$gs_name)
MF_list <- split(GO_MF$ensembl_gene, GO_MF$gs_name)

```

```{r}
# Create the ranked list of isoform-level statistics
dex_vals <- dexseqResultGene_1$stat
dex_names <- dexseqResultGene_1$gene_id_clean

stats_dex <- setNames(dex_vals, dex_names)

stats_dex <- stats_dex[!is.na(stats_dex)]
stats_dex <- sort(stats_dex, decreasing = TRUE) # sort in decreasing order (required for FGSEA)
```

Run FGSEA (FSC) for DEX

```{r}
#Biological Process
fg_diu_BP <- fgseaMultilevel(
  pathways = BP_list,
  stats = stats_dex,
  minSize = 15,
  maxSize = 500,
  scoreType = "std"
)

sig_dx_BP <- fg_diu_BP  |>  filter(padj < 0.05)

# Cellular Component
fg_diu_CC <- fgseaMultilevel(
  pathways = CC_list,
  stats = stats_dex,
  minSize = 15,
  maxSize = 500,
  scoreType = "std"
)

sig_dx_CC <- fg_diu_CC %>% filter(padj < 0.05)

# Molecular Function
fg_diu_MF <- fgseaMultilevel(
  pathways = MF_list,
  stats = stats_dex,
  minSize = 15,
  maxSize = 500,
  scoreType = "std"
)

sig_dx_MF <- fg_diu_MF %>% filter(padj < 0.05)

```

```{r}
n_sig_dx_BP <- nrow(sig_dx_BP)
n_sig_dx_BP

n_sig_dx_CC <- nrow(sig_dx_CC)
n_sig_dx_CC

n_sig_dx_MF <- nrow(sig_dx_MF)
n_sig_dx_MF
```

```{r}
hist(dexseqResultGene_1$stat, breaks = 100)
```

```{r}
sum(names(stats_dex) %in% GO_BP$ensembl_gene)
```

ORA

```{r}
# Significant DEX genes
dex_genes <- dexseqResultGene_1  |> 
    filter(padj_gene < 0.05)  |> 
    pull(gene_id_clean)

length(dex_genes)  # how many DEX genes

# Background universe = all genes tested by DEXSeq
universe <- dexseqResultGene_1$gene_id_clean
length(universe)

```

```{r}
BP_ora <- fora(BP_list, dex_genes, universe)
sig_BP_ora <- BP_ora  |>  filter(padj < 0.05)
head(sig_BP_ora)

CC_ora <- fora(CC_list, dex_genes, universe)
sig_CC_ora <- CC_ora %>% filter(padj < 0.05)
head(sig_CC_ora)

MF_ora <- fora(MF_list, dex_genes, universe)
sig_MF_ora <- MF_ora %>% filter(padj < 0.05)
head(sig_MF_ora)
```

PLOTTTING

Volcano plot for gene-level (DEXSeq)

```{r}
volcano_diu <- dexseqResultGene_1  |> 
  mutate(
    sig = padj_gene < 0.05,
    direction = case_when(
      padj_gene < 0.05 & log2FC > 1  ~ "Up in Obese",
      padj_gene < 0.05 & log2FC < -1 ~ "Down in Obese",
      TRUE ~ "Not significant"
    )
  )

p2 <- ggplot(volcano_diu, aes(x = log2FC, y = -log10(padj_gene), color = direction)) +
  geom_point(alpha = 0.6, size = 1.8) +
  scale_color_manual(values = c(
    "Up in Obese" = "firebrick",
    "Down in Obese" = "royalblue",
    "Not significant" = "grey70"
  )) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  labs(
    title = "Volcano Plot — Differential Isoform Usage (gene-level DEXSeq)",
    x = "log2 Fold Change (Obese vs Normal)",
    y = "-log10(FDR)",
    color = "Direction"
  ) +
  theme_minimal(base_size = 13)
p2

ggsave("../figures/volc_dex_GSE165932.png", plot = p2)
```

```{r}
library(cowplot)
library(dplyr)
library(ggplot2)

# 1) Ordered top DIU-only genes (your ranking)
dex_only_genes_ordered <- merged %>%
  filter(DEX_sig & !DE_sig) %>%
  arrange(padj_gene) %>%
  slice_head(n = 10) %>%
  pull(gene_id.y)

# 2) We'll store the plots AND the actual genes that were plotted
combined_list <- list()
plotted_genes <- tibble(
  rank = integer(),
  gene_id = character(),
  gene_symbol = character()
)

# Create ENSG -> gene symbol lookup for GSE165932
# Run this BEFORE compute_delta_usage() and the for-loop

gene_lookup <- isoInfo_subset_1 %>%
  dplyr::distinct(gene_id, gene_name)

compute_delta_usage <- function(gene_id) {
  
  isoforms <- isoInfo_subset_1 %>%
    dplyr::filter(gene_id == !!gene_id) %>%
    dplyr::pull(transcript_id)
  
  if (length(isoforms) < 2) {
    message("Gene ", gene_id, " has <2 isoforms. Skipping.")
    return(NULL)
  }
  
  mat <- iso_count_matrix_1[isoforms, , drop = FALSE]
  if (nrow(mat) < 2) {
    message("Isoform rows missing for gene ", gene_id)
    return(NULL)
  }
  
  props <- sweep(mat, 2, colSums(mat), "/")
  
  props_df <- as.data.frame(t(props))
  props_df$sample <- rownames(props_df)
  
  props_df <- merge(
    props_df,
    gene_meta_1[, c("sample", "condition")],
    by = "sample",
    sort = FALSE
  )
  
  numeric_cols <- names(props_df) %in% isoforms
  
  obese_props  <- props_df[props_df$condition == "Obese",  numeric_cols, drop = FALSE]
  normal_props <- props_df[props_df$condition == "Normal", numeric_cols, drop = FALSE]
  
  obese_means  <- colMeans(obese_props,  na.rm = TRUE)
  normal_means <- colMeans(normal_props, na.rm = TRUE)
  
  gene_symbol <- gene_lookup %>%
    dplyr::filter(gene_id == !!gene_id) %>%
    dplyr::pull(gene_name)
  
  tibble::tibble(
    gene_id = gene_id,
    gene_symbol = ifelse(length(gene_symbol) == 0, gene_id, gene_symbol),
    isoform = isoforms,
    delta_usage = obese_means - normal_means
  )
}


i <- 1
for (g in dex_only_genes_ordered) {
  
  delta_df <- compute_delta_usage(g)
  if (is.null(delta_df)) {
    message("Skipping gene (not enough isoforms / counts): ", g)
    next
  }
  
  # get symbol from delta_df (we added it in compute_delta_usage)
  symbol <- delta_df$gene_symbol[1]
  
  p <- ggplot(delta_df, aes(
    x = reorder(isoform, delta_usage),
    y = delta_usage,
    fill = delta_usage > 0
  )) +
    geom_col() +
    coord_flip() +
    scale_fill_manual(
      values = c("TRUE" = "firebrick", "FALSE" = "royalblue"),
      labels = c("TRUE" = "Higher in Obese", "FALSE" = "Higher in Normal")
    ) +
    labs(
      title = paste0(i, ". ", symbol, " (", g, ")"),
      x = "Isoform",
      y = "Δ proportion (Obese − Normal)"
    ) +
    theme_minimal(base_size = 11) +
    theme(
      legend.position = "none",
      plot.title = element_text(hjust = 0, face = "bold", size = 12)
    )
  
  combined_list[[i]] <- p
  
  plotted_genes <- add_row(
    plotted_genes,
    rank = i,
    gene_id = g,
    gene_symbol = symbol
  )
  
  i <- i + 1
}

# 3) Make combined plot from the plots that actually exist, in this order
combined_plot <- plot_grid(
  plotlist = combined_list,
  ncol = 2,
  align = "hv"
)

ggsave(
  "../figures/combined_delta_usage_summary_ORDERED_GSE165932.png",
  combined_plot,
  width = 14, height = 11
)

# 4) Print the genes in the exact same order as the panels
plotted_genes
```
